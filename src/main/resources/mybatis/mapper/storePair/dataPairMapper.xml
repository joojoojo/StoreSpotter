<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sojoo.StoreSpotter.dao.storePair.DataPairMapper">

    <select id="selectConvenienceData" parameterType="com.sojoo.StoreSpotter.dto.apiToDb.StoreInfo">
        SELECT bizes_id, bizes_nm, rdnm_adr, ST_AsText(coordinates) AS coordinates, region_fk
        FROM convenience_store
    </select>

    <!-- 카페 데이터 -->
    <select id="selectCafeData" parameterType="com.sojoo.StoreSpotter.dto.apiToDb.StoreInfo">
        SELECT bizes_id, bizes_nm, rdnm_adr, ST_AsText(coordinates) AS coordinates, region_fk
        FROM cafe
    </select>


    <insert id="insertPairData" keyProperty="pair_id">
        INSERT INTO convenience_pair (st_nm, st_coor, com_nm, com_coor, dist, region_fk)
        VALUES ((#{pairData.st_nm}), ST_GeomFromText(#{pairdata.st_coor}, 4326), #{pairData.com_nm}, ST_GeomFromText(#{pairData.com_coor}, 4326), #{pairData.dist}, #{pairData.region_fk})
    </insert>


    <select id="distanceSphere">
            SELECT ST_DISTANCE_SPHERE(ST_GeomFromText(#{point}), coordinates) AS dist,
                   #{region} AS region_fk,
                   #{name} AS st_nm,
                   #{point} AS st_coor,
                   bizes_nm AS com_nm,
                   ST_AsWKT(coordinates) AS com_coor
            FROM convenience_store
            WHERE convenience_store.region_fk = #{region} AND ST_DISTANCE_SPHERE(ST_GeomFromText(#{point}), coordinates) > 0
            ORDER BY dist
            LIMIT 1;
    </select>





</mapper>